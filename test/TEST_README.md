# 后端接口测试使用说明

## 快速开始

### 1. 安装依赖

```bash
pip3 install requests
```

### 2. 启动后端服务

```bash
# 在backend目录下
cd backend
go run main.go
```

### 3. 运行测试

```bash
# 在项目根目录下
python3 test_api.py
```

### 4. 查看测试报告

测试完成后,查看生成的测试报告:

```bash
cat docs/test_report.md
```

## 测试文件说明

| 文件名 | 说明 |
|--------|------|
| `test_api.py` | 主测试脚本,自动测试所有后端接口 |
| `promote_admin.py` | 辅助脚本,手动提升用户为管理员 |
| `requirements_test.txt` | Python测试依赖 |
| `docs/test_plan.md` | 详细的测试方案文档 |
| `docs/test_report.md` | 自动生成的测试报告 |

## 测试特性

✅ **全自动化**: 无需手动创建测试数据  
✅ **高覆盖率**: 覆盖30个主要API接口  
✅ **详细报告**: 自动生成Markdown格式测试报告  
✅ **Session管理**: 自动处理Cookie认证  
✅ **权限提升**: 自动提升管理员权限测试管理接口  

## 测试结果

最新测试结果:
- **通过率**: 96.67%
- **测试数**: 30个接口
- **通过数**: 29个
- **失败数**: 1个

## 手动提升管理员(可选)

如果需要手动将某个用户提升为管理员:

```bash
python3 promote_admin.py <手机号>

# 示例
python3 promote_admin.py 13800138000
```

## 测试覆盖的接口

### 用户认证 (7个)
- 用户注册
- 用户登录  
- 获取当前用户信息
- 修改昵称
- 修改密码
- 用户登出
- 未登录访问(异常测试)

### 房间管理 (4个)
- 创建房间
- 加入房间
- 获取房间详情
- 返回上次房间

### 房间操作 (9个)
- 德扑下注
- 德扑再次下注
- 收回积分
- 全收积分
- 获取操作历史
- 获取历史金额
- 创建牛牛房间
- 加入牛牛房间
- 牛牛下注

### 结算 (2个)
- 发起结算
- 确认结算

### 战绩统计 (2个)
- 查询今晚战绩
- 查询指定时间范围战绩

### 后台管理 (6个)
- 普通用户访问管理接口(应失败)
- 获取所有用户列表
- 获取所有房间列表
- 获取房间详细信息
- 获取用户历史盈亏
- 获取用户进出房间历史

## 注意事项

1. **测试环境**: 建议在测试环境运行,不要在生产环境执行
2. **数据库**: 测试会创建新数据,不会删除现有数据
3. **端口**: 确保后端服务运行在 `localhost:8080`
4. **清理**: 建议定期清理测试数据

## 常见问题

### Q: 测试失败怎么办?

检查以下几点:
1. 后端服务是否正常运行 (`curl http://localhost:8080/ping`)
2. 数据库文件是否存在 (`backend/database.db`)
3. 查看测试报告中的具体错误信息
4. 查看后端日志

### Q: 如何只测试某个模块?

编辑 `test_api.py`,注释掉不需要的测试函数调用:

```python
# 在main()函数中
test_auth_apis()      # 测试认证接口
# test_room_apis()    # 注释掉房间测试
# test_operation_apis() # 注释掉操作测试
```

### Q: WebSocket如何测试?

WebSocket需要手动测试或使用专门工具,推荐:
- wscat: `npm install -g wscat`
- Postman: 支持WebSocket连接
- 浏览器开发者工具

## 更多信息

详细的测试方案请查看: [docs/test_plan.md](docs/test_plan.md)  
API接口文档请查看: [docs/api.md](../docs/api.md)

## 联系方式

如有问题,请查看项目README或创建Issue。

---

**版本**: 1.0  
**更新时间**: 2025-11-06

